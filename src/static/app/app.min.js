var MatchingApp=angular.module("MatchingApp",["ngRoute","ngSanitize","ui.gravatar","btford.markdown","ui.slider"]);MatchingApp.config(function($routeProvider){$routeProvider.when("/profile",{controller:"ProfileController",templateUrl:"static/app/views/profile.html"}).when("/engine/topics/:keyword",{controller:"IterationController",templateUrl:"static/app/views/engine.html"}).when("/engine/search",{controller:"SearchController",templateUrl:"static/app/views/search.html"}).otherwise({redirectTo:"/profile"})}),MatchingApp.config(function($interpolateProvider){$interpolateProvider.startSymbol("{["),$interpolateProvider.endSymbol("]}")}),MatchingApp.service("Api",function($http){this.updateBio=function(newBio){return $http.post("/update_bio",{bio_new_text:newBio})},this.getProfile=function(){return $http.get("/profile")},this.updateArticle=function(article){$http.post("/article/"+article.key+"/edit",{new_title:article.title,new_abstract:article["abstract"]})},this.getArticleWithKey=function(key){return $http.get("/article/"+key)},this.topics=function(keyword){return console.log(encodeURIComponent(keyword)),{success:function(callback){var topics=[{weight:Math.round(100*Math.random()),selected:!1},{weight:Math.round(100*Math.random()),selected:!1},{weight:Math.round(100*Math.random()),selected:!1},{weight:Math.round(100*Math.random()),selected:!1},{weight:Math.round(100*Math.random()),selected:!1},{weight:Math.round(100*Math.random()),selected:!1}];topics.forEach(function(topic){topic.relatedArticles=[],topic.keywords=[],_.times(10,function(){topic.keywords.push({content:"lorem",weight:Math.random()})}),_.times(5,function(){topic.relatedArticles.push({title:"Lorem ipsum dolor sit amet",authors:"Lorem ipsum, Dolor sit","abstract":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. In sodales ex eget nibh facilisis, eget condimentum neque sollicitudin. Sed rutrum tempus malesuada. Donec laoreet nec sapien quis dictum. Nulla ultrices pretium lorem, sit amet malesuada magna sagittis nec. Nullam id purus posuere, pretium quam non, pulvinar elit. Suspendisse purus elit, sodales et magna sit amet, molestie tempus turpis. Phasellus ut accumsan purus.",weight:Math.random()})})}),callback(topics)}}}}),MatchingApp.service("EngineModels",function(){function rotateVector(vector,angle){return{x:vector.x*Math.cos(angle)-vector.y*Math.sin(angle),y:vector.x*Math.sin(angle)+vector.y*Math.cos(angle)}}function Cloud(raphael,attr){this.raphael=raphael,this.middle=attr.middle,this.labels=[],this.title=null,this.labelStartPoint=attr.labelStartPoint||{x:this.middle.x-CLOUDSIZE/2,y:this.middle.y-CLOUDSIZE/2}}function Label(raphael,attr){this.PADDING=6,this.BG_COLOR="#485563",this.raphael=raphael,this.content=attr.content,this.weight=attr.weight,this.middle=attr.middle,this.id=_.uniqueId(),this.removed=!1}var CLOUDSIZE=500;Cloud.prototype.setTitle=function(title){this.title&&this.title.remove(),this.title=this.raphael.text(this.middle.x,this.middle.y,title).attr({"font-size":20,fill:"#333","font-family":"Helvetica, Arial, sans-serif"})},Cloud.prototype.render=function(){this.raphael.circle(this.middle.x,this.middle.y,250).attr({fill:"#EDEFF0",stroke:"none"}),this.raphael.circle(this.middle.x,this.middle.y,180).attr({fill:"#DCDFE2",stroke:"none"}),this.raphael.circle(this.middle.x,this.middle.y,110).attr({fill:"#CACED3",stroke:"none"}),this.raphael.circle(this.middle.x,this.middle.y,40).attr({fill:"#B8BEC4",stroke:"none"})},Cloud.prototype.setLabels=function(labels){this.labels.forEach(function(label){label.remove({animate:!1})}),this.labels=labels;var rotateAngle=2*Math.PI/labels.length,unitVector={x:0,y:1},cloud=this;_.where(this.labels,{removed:!1}).forEach(function(label){label.render({x:cloud.labelStartPoint.x,y:cloud.labelStartPoint.y});var dim=label.dimensions(),vectorWidth=(label.distanceTo(cloud.middle.x,cloud.middle.y),(1-label.weight)*(CLOUDSIZE/2)),positionVector={x:cloud.middle.x+unitVector.x*vectorWidth,y:cloud.middle.y+unitVector.y*vectorWidth};label.smoothMove(positionVector.x-dim.width/2,positionVector.y-dim.height/2),label.setWeight(label.weight),unitVector=rotateVector(unitVector,rotateAngle)})},Label.prototype.inBounds=function(newX,newY){var dim=this.dimensions(),middle={x:newX+dim.width/2,y:newY+dim.height/2},leftBound=middle.x<this.middle.x-CLOUDSIZE/2,rightBound=middle.x>this.middle.x+CLOUDSIZE/2,topBound=middle.y<this.middle.y-CLOUDSIZE/2,bottomBound=middle.y>this.middle.y+CLOUDSIZE/2;return{left:leftBound,right:rightBound,top:topBound,bottom:bottomBound}},Label.prototype.bringFront=function(){this.background.toFront(),this.text.toFront(),this.handle.toFront()},Label.prototype.render=function(options){this.removed=!1,this.text=this.raphael.text(0,0,this.content).attr({"font-size":14,fill:"white","font-family":"Helvetica, Arial, sans-serif"});var textDim=this.text.getBBox();this.background=this.raphael.rect(options.x,options.y,2*this.PADDING+textDim.width,2*this.PADDING+textDim.height,4).attr({fill:this.BG_COLOR,stroke:"none"});var backgroundDim=this.background.getBBox();this.text.attr({x:textDim.width/2+backgroundDim.x+this.PADDING,y:textDim.height/2+backgroundDim.y+this.PADDING}),this.handle=this.background.clone(),this.handle.attr({fill:"rgba(0,0,0,.0)",stroke:"none",cursor:"pointer"}),this.handle.parent=this,this.bringFront()},Label.prototype.collides=function(keyword){var me=this.handle.getBBox(),target=keyword.handle.getBBox();return!(target.x>me.x+me.width||target.x+target.width<me.x||target.y>me.y+me.height||target.y+target.height<me.y)},Label.prototype.setBgColor=function(color){this.background.attr({fill:color})},Label.prototype.setOpacity=function(opacity){this.text.animate({opacity:opacity},300),this.background.animate({opacity:opacity},300)},Label.prototype.setFontColor=function(color){this.text.attr({fill:color})},Label.prototype.setWeight=function(weight){var color=tinycolor(this.BG_COLOR);this.weight=weight;var lightness=(this.distanceTo(this.middle.x,this.middle.y),Math.round(50*this.weight+50));this.setBgColor(color.lighten(100-lightness)),this.setFontColor(this.weight<.3?"#333":"white")},Label.prototype.distanceTo=function(x,y){var dim=this.dimensions(),middle={x:dim.x+dim.width/2,y:dim.y+dim.height/2},distanceX=Math.abs(x-middle.x),distanceY=Math.abs(y-middle.y);return Math.sqrt(Math.pow(distanceX,2)+Math.pow(distanceY,2))},Label.prototype.remove=function(options){options.animate?(this.text.animate({opacity:0},300,"<",function(){this.remove()}),this.background.animate({opacity:0},300,"<",function(){this.remove()})):(this.text.remove(),this.background.remove()),this.handle.remove()},Label.prototype.smoothMove=function(x,y,callback){var _this=this,textDim=this.text.getBBox();this.background.animate({x:x,y:y},300,"<"),this.handle.animate({x:x,y:y},300,"<",function(){var distanceToMiddle=_this.distanceTo(_this.middle.x,_this.middle.y);_this.setWeight(Math.max(0,1-distanceToMiddle/(CLOUDSIZE/2))),$.isFunction(callback)&&callback()}),this.text.animate({x:textDim.width/2+x+this.PADDING,y:textDim.height/2+y+this.PADDING},300,"<"),this.bringFront()},Label.prototype.move=function(x,y){var textDim=this.text.getBBox();this.background.attr({x:x,y:y}),this.handle.attr({x:x,y:y}),this.text.attr({x:textDim.width/2+x+this.PADDING,y:textDim.height/2+y+this.PADDING});var distanceToMiddle=this.distanceTo(this.middle.x,this.middle.y);this.setWeight(Math.max(0,1-distanceToMiddle/(CLOUDSIZE/2))),this.bringFront()},Label.prototype.setBorderColor=function(color){color?(this.background.attr({"stroke-width":"3"}),this.background.attr({stroke:color})):this.background.attr({stroke:"none"})},Label.prototype.dimensions=function(){var dim=this.handle.getBBox();return{x:this.handle.attr("x"),y:this.handle.attr("y"),width:dim.width,height:dim.height}},this.getCloudSize=function(){return CLOUDSIZE},this.createLabel=function(raphael,attr){return new Label(raphael,attr)},this.createCloud=function(raphael,attr){return new Cloud(raphael,attr)}}),MatchingApp.service("Fileupload",function(){this.init=function(files,options){function scriptsLoaded(){$("#fileupload").ready(function(){var $form=$("#fileupload");$form.fileupload("option","done").call($form,$.Event("done"),{result:{files:files}}),$form.on("click",".paper-title",function(e){e.preventDefault();var title=$(this).attr("data-title"),key=$(this).attr("data-key");options.fileClicked({title:title,key:key})}),$form.bind("fileuploadsubmit",function(e,data){var inputs=data.context.find(":input");return inputs.filter(function(){return!this.value&&$(this).prop("required")}).first().focus().length?(data.context.find("button").prop("disabled",!1),!1):void(data.formData=inputs.serializeArray())})})}function downloadTemplateLoaded(data){window.downloadTemplate=data,$("#ajax-load-scripts").load("static/scripts.html",scriptsLoaded)}function uploadTemplateLoaded(data){window.uploadTemplate=data,$.get("static/template-download.tmpl",downloadTemplateLoaded)}$(function(){$.get("static/template-upload.tmpl",uploadTemplateLoaded)})},this.updateFile=function(file){var $fileEl=$("#fileupload").find("a[data-key="+file.key+"]");$fileEl.html(file.title),$fileEl.removeAttr("data-title"),$fileEl.attr("data-title",file.title)}}),MatchingApp.service("Utils",function(){this.articlesToChartData=function(articles){var data=_.map(articles,function(article){return{value:Math.round(100*article.weight),label:article.title,data:article}});return data},this.topicsToHistoryData=function(topics){var weightSum=_.sum(topics,"weight");console.log(weightSum);var data=_.map(topics,function(topic){return{keywordsToString:_(topic.keywords).map(function(keyword){return keyword.content}).value().join(", "),portion:topic.weight/weightSum*100+"%"}});return data}}),MatchingApp.directive("autofocus",["$timeout",function($timeout){return{restrict:"A",link:function($scope,$element){$timeout(function(){$element[0].focus()})}}}]),MatchingApp.directive("cluster",function(EngineModels){function bindKeywords(keywords,onChange){raphael.set(_.map(keywords,function(keyword){return keyword.handle})).click(function(){}).hover(function(){this.parent.bringFront()}).dblclick(function(){var parent=this.parent;parent.removed=!0,parent.remove({animate:!0})}).drag(function(dx,dy){dragMove(this,dx,dy)},function(){dragStart(this)},function(){var collision=!1,parent=this.parent;_.where(keywords,{removed:!1}).forEach(function(keyword){parent!=keyword&&parent.collides(keyword)&&(collision=!0)}),collision?parent.smoothMove(this.ox,this.oy,function(){onChange()}):onChange(),dragEnd(this)})}function bindTopics(topics,onChange){raphael.set(_.map(topics,function(topic){return topic.handle})).click(function(){topics.forEach(function(topic){topic.setBorderColor(null)});var _this=this,targetTopic=_.find(topics,{id:_this.parent.id});keywordCloud.setTitle('Drag keywords related to "'+targetTopic.content+'" here'),keywordCloud.labelStartPoint={x:targetTopic.dimensions().x,y:targetTopic.dimensions().y},keywordCloud.setLabels(targetTopic.keywords),this.parent.bringFront(),bindKeywords(targetTopic.keywords,onChange),this.parent.setBorderColor("#337AB7")}).hover(function(){this.parent.bringFront()}).dblclick(function(){var parent=this.parent;parent.removed=!0,parent.remove({animate:!0}),keywordCloud.setLabels([]),keywordCloud.setTitle("Choose a topic to see its keywords")}).drag(function(dx,dy){dragMove(this,dx,dy)},function(){dragStart(this)},function(){var collision=!1,parent=this.parent;_.where(topics,{removed:!1}).forEach(function(topic){parent!=topic&&parent.collides(topic)&&(collision=!0)}),collision?parent.smoothMove(this.ox,this.oy,function(){onChange()}):onChange(),dragEnd(this)})}function dragMove(el,dx,dy){var newX=el.ox+dx,newY=el.oy+dy,dim=el.parent.dimensions(),bounds=el.parent.inBounds(newX,newY);bounds.left&&(newX=el.parent.middle.x-CLOUDSIZE/2-dim.width/2),bounds.right&&(newX=el.parent.middle.x+CLOUDSIZE/2-dim.width/2),bounds.top&&(newY=el.parent.middle.y-CLOUDSIZE/2-dim.height/2),bounds.bottom&&(newY=el.parent.middle.y+CLOUDSIZE/2-dim.height/2),el.parent.move(newX,newY)}function dragStart(el){var pos=el.parent.dimensions();el.ox=pos.x,el.oy=pos.y,el.attr({cursor:"move"}),el.parent.setOpacity(.7)}function dragEnd(el){el.attr({cursor:"pointer"}),el.parent.setOpacity(1)}function updateModel(scope){var formattedTopics=_.map(function(topic){var formattedKeywords=_.map(function(keyword){return{content:keyword.content,weight:keyword.weight,removed:keyword.removed}});return{content:topic.content,weight:topic.weight,removed:topic.removed,keywords:formattedKeywords}});scope.$apply(function(){scope.topics=formattedTopics})}function initTopics(topicData,topicCloud,keywordCloud){topics=[],topicData.forEach(function(topic){var topicAttr=_.clone(topic);topicAttr.middle=topicCloud.middle;var topicLabel=EngineModels.createLabel(raphael,topicAttr);topicLabel.keywords=[],topic.keywords.forEach(function(keyword){var keywordAttr=_.clone(keyword);keywordAttr.middle=keywordCloud.middle,topicLabel.keywords.push(EngineModels.createLabel(raphael,keywordAttr))}),topics.push(topicLabel)})}var raphael,topicCloud,CLOUDSIZE=EngineModels.getCloudSize(),topics=[],keywordCloud=null;return{scope:{topics:"=ngModel"},template:'<div class="cluster-raphael"></div>',link:function(scope,elem){raphael=Raphael($(elem).children(".cluster-raphael")[0],2*CLOUDSIZE,CLOUDSIZE),$(elem).addClass("cluster"),topicCloud=EngineModels.createCloud(raphael,{middle:{x:250,y:250}}),keywordCloud=EngineModels.createCloud(raphael,{middle:{x:850,y:250}}),initTopics(scope.topics,topicCloud,keywordCloud),topicCloud.render(),topicCloud.setTitle("Drag relevant topics here"),keywordCloud.render(),topicCloud.setLabels(topics),keywordCloud.setTitle('Drag keywords relevant to "'+topics[0].content+'" here'),keywordCloud.labelStartPoint={x:topics[0].dimensions().x,y:topics[0].dimensions().y},keywordCloud.setLabels(topics[0].keywords),bindTopics(topics,function(){updateModel(scope)}),bindKeywords(topics[0].keywords,function(){updateModel(scope)})}}}),MatchingApp.directive("polarChart",function($timeout){return{scope:{data:"=ngModel",click:"="},link:function(scope,elem){var colors=[{color:"#F7464A",highlight:"#FF5A5E"},{color:"#46BFBD",highlight:"#5AD3D1"},{color:"#FDB45C",highlight:"#FFC870"},{color:"#949FB1",highlight:"#A8B3C5"},{color:"#4D5360",highlight:"#616774"}];scope.$watch("data",function(){scope.data&&(scope.data.forEach(function(d,index){d.color=colors[index].color,d.highlight=colors[index].highlight}),$timeout(function(){var canvas=document.createElement("canvas");canvas.width=350,canvas.height=350,$(elem).empty().append(canvas);var polar=new Chart($(canvas)[0].getContext("2d")).PolarArea(scope.data);$(canvas).on("click",function(evt){var segment=polar.getSegmentsAtEvent(evt),clickData=_.find(scope.data,{highlight:segment[0].fillColor}).data;scope.$apply(function(){scope.click(clickData)})})}))})}}}),MatchingApp.directive("tooltip",function(){return{scope:{content:"="},restrict:"A",link:function(scope,element){$(element).tooltip({container:"body",title:scope.content})}}}),MatchingApp.directive("topic",function(){return{scope:{topic:"=ngModel"},link:function(scope,elem){$(elem).slider()}}}),MatchingApp.directive("upload",function(){return{scope:{added:"=",uploaded:"=",files:"="},link:function(scope,elem){$(elem).fileupload().bind("fileuploadadd",function(e,data){scope.added(data)}).bind("fileuploaddone",function(e,data){scope.uploaded(data)})}}}),MatchingApp.controller("IterationController",function($scope,$rootScope,$routeParams,$location,Api,Utils){function fetchTopics(){$scope.loading=!0,Api.topics($scope.keyword).success(function(topics){$scope.topics=topics,$scope.loading=!1})}$rootScope.activeLink="engine",$scope.keyword=$routeParams.keyword,$scope.iterationHistory=[],$scope.currentIteration=1,fetchTopics(),$scope.unchooseTopics=function(){$scope.topics.forEach(function(topic){topic.selected=!1}),$scope.relatedArticles=null,$scope.chosenArticle=null},$scope.chooseTopic=function(topic){$scope.unchooseTopics(),$scope.relatedArticles=Utils.articlesToChartData(topic.relatedArticles),$scope.chosenArticle=_.max(topic.relatedArticles,"weight"),topic.selected=!0},$scope.chooseArticle=function(article){$scope.chosenArticle=article},$scope.toggleHistory=function(){$scope.showHistory=!$scope.showHistory},$scope.newSearch=function(){confirm("Are you sure you want to start a new search?")&&$location.path("engine/search")},$scope.next=function(){var mostWeight=_($scope.topics).sortBy("-weight").take(3).value(),historyTopics=Utils.topicsToHistoryData(mostWeight);$scope.iterationHistory.push({iteration:$scope.currentIteration,topics:historyTopics}),$scope.currentIteration++,console.log($scope.iterationHistory),fetchTopics()}}),MatchingApp.controller("ProfileController",function($scope,$rootScope,Api,Fileupload){$scope.activeFile={},$rootScope.activeLink="profile",Api.getProfile().success(function(profile){$scope.bio={editing:!1,content:profile.bio,files:angular.fromJson(profile.files),user:profile.user,email:profile.email},Fileupload.init($scope.bio.files,{fileClicked:function(file){$("#article-abstract-modal").modal("show"),$scope.$apply(function(){$scope.activeFile.loading=!0,$scope.activeFile.error=!1,$scope.activeFile.title=file.title,$scope.activeFile.key=file.key}),Api.getArticleWithKey(file.key).success(function(article){$scope.activeFile.loading=!1,$scope.activeFile["abstract"]=article["abstract"]}).error(function(){$scope.activeFile.loading=!1,$scope.activeFile.error=!0})}})}),$scope.editBio=function(){$scope.bio.editing=!0},$scope.updateBio=function(){Api.updateBio($scope.bio.content).success(function(){$scope.bio.editing=!1})},$scope.saveArticle=function(){$scope.bio.files.forEach(function(file){file.key==$scope.activeFile.key&&(file.title=$scope.activeFile.title)}),Api.updateArticle(_.pick($scope.activeFile,"title","abstract","key")),Fileupload.updateFile(_.pick($scope.activeFile,"title","key")),$("#article-abstract-modal").modal("hide")}}),MatchingApp.controller("SearchController",function($scope,$rootScope,$location){$rootScope.activeLink="engine",$scope.search=function(){$location.path("engine/topics/"+$scope.keyword)}});