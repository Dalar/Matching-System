var MatchingApp=angular.module("MatchingApp",["ngRoute","ngSanitize","ui.gravatar","btford.markdown"]);MatchingApp.config(function($routeProvider){$routeProvider.when("/profile",{controller:"ProfileController",templateUrl:"static/app/views/profile.html"}).otherwise({redirectTo:"/profile"})}),MatchingApp.config(function($interpolateProvider){$interpolateProvider.startSymbol("{["),$interpolateProvider.endSymbol("]}")}),MatchingApp.service("Api",function($http){this.updateBio=function(newBio){return $http.post("/update_bio",{bio_new_text:newBio})},this.getProfile=function(){return $http.get("/profile")}}),MatchingApp.service("Fileupload",function(){this.init=function(files){function scriptsLoaded(){var $form=$("#fileupload");$form.fileupload("option","done").call($form,$.Event("done"),{result:{files:files}}),$form.bind("fileuploadsubmit",function(e,data){var inputs=data.context.find(":input");return inputs.filter(function(){return!this.value&&$(this).prop("required")}).first().focus().length?(data.context.find("button").prop("disabled",!1),!1):void(data.formData=inputs.serializeArray())}),$(document).ready(function(){$("#btn-save").click(function(){var text=$("#bio-text").val();$.ajax({type:"POST",url:"/update_bio",data:{bio_new_text:JSON.stringify(text)},dataType:"json",success:function(){window.location.reload(!0)}})})})}function downloadTemplateLoaded(data){window.downloadTemplate=data,$("#ajax-load-scripts").load("static/scripts.html",scriptsLoaded)}function uploadTemplateLoaded(data){window.uploadTemplate=data,$.get("static/template-download.tmpl",downloadTemplateLoaded)}$(function(){$.get("static/template-upload.tmpl",uploadTemplateLoaded)})}}),MatchingApp.directive("cluster",function(){function rotateVector(vector,angle){return{x:vector.x*Math.cos(angle)-vector.y*Math.sin(angle),y:vector.x*Math.sin(angle)+vector.y*Math.cos(angle)}}function initBackground(raphael){raphael.circle(WIDTH/2,HEIGHT/2,250).attr({fill:"#EDEFF0",stroke:"none"}),raphael.circle(WIDTH/2,HEIGHT/2,180).attr({fill:"#DCDFE2",stroke:"none"}),raphael.circle(WIDTH/2,HEIGHT/2,110).attr({fill:"#CACED3",stroke:"none"}),raphael.circle(WIDTH/2,HEIGHT/2,40).attr({fill:"#B8BEC4",stroke:"none"})}function initKeywords(keywords){var rotateAngle=2*Math.PI/keywords.length,unitVector={x:0,y:1};keywords.forEach(function(keyword){var dim=keyword.dimensions(),vectorWidth=(keyword.distanceTo(WIDTH/2,HEIGHT/2),(1-keyword.weight)*(WIDTH/2)),positionVector={x:WIDTH/2+unitVector.x*vectorWidth,y:HEIGHT/2+unitVector.y*vectorWidth};keyword.smoothMove(positionVector.x-dim.width/2,positionVector.y-dim.height/2),keyword.setWeight(keyword.weight),unitVector=rotateVector(unitVector,rotateAngle)})}function Topic(raphael,attr){this.raphael=raphael,this.content=attr.content,this.weight=attr.weight}function Keyword(raphael,attr){this.PADDING=6,this.BG_COLOR="#485563",this.raphael=raphael,this.content=attr.content,this.weight=attr.weight}var WIDTH=500,HEIGHT=500;return Topic.prototype.render=function(options){this.handle=this.raphael.text(options.x,options.y,this.content).attr({"font-size":24,fill:"#333","font-family":"Helvetica, Arial, sans-serif",cursor:"pointer"})},Keyword.prototype.bringFront=function(){this.background.toFront(),this.text.toFront(),this.handle.toFront()},Keyword.prototype.render=function(options){this.text=this.raphael.text(0,0,this.content).attr({"font-size":14,fill:"white","font-family":"Helvetica, Arial, sans-serif"});var textDim=this.text.getBBox();this.background=this.raphael.rect(options.x,options.y,2*this.PADDING+textDim.width,2*this.PADDING+textDim.height,4).attr({fill:this.BG_COLOR,stroke:"none"});var backgroundDim=this.background.getBBox();this.text.attr({x:textDim.width/2+backgroundDim.x+this.PADDING,y:textDim.height/2+backgroundDim.y+this.PADDING}),this.handle=this.background.clone(),this.handle.attr({fill:"rgba(0,0,0,.0)",stroke:"none",cursor:"pointer"}),this.handle.parent=this,this.bringFront()},Keyword.prototype.collides=function(keyword){var me=this.handle.getBBox(),target=keyword.handle.getBBox();return!(target.x>me.x+me.width||target.x+target.width<me.x||target.y>me.y+me.height||target.y+target.height<me.y)},Keyword.prototype.setBgColor=function(color){this.background.attr({fill:color})},Keyword.prototype.setFontColor=function(color){this.text.attr({fill:color})},Keyword.prototype.setWeight=function(weight){var color=tinycolor(this.BG_COLOR);this.weight=weight;var lightness=(this.distanceTo(WIDTH/2,HEIGHT/2),Math.round(50*this.weight+50));this.setBgColor(color.lighten(100-lightness)),this.setFontColor(this.weight<.3?"#333":"white")},Keyword.prototype.distanceTo=function(x,y){var dim=this.dimensions(),middle={x:dim.x+dim.width/2,y:dim.y+dim.height/2},distanceX=Math.abs(x-middle.x),distanceY=Math.abs(y-middle.y);return Math.sqrt(Math.pow(distanceX,2)+Math.pow(distanceY,2))},Keyword.prototype.remove=function(callback){this.text.animate({opacity:0},300,"<",function(){this.remove()}),this.background.animate({opacity:0},300,"<",function(){this.remove(),$.isFunction(callback)&&callback()}),this.handle.remove()},Keyword.prototype.smoothMove=function(x,y){var _this=this,textDim=this.text.getBBox();this.background.animate({x:x,y:y},300,"<"),this.handle.animate({x:x,y:y},300,"<",function(){var distanceToMiddle=_this.distanceTo(WIDTH/2,HEIGHT/2);_this.setWeight(Math.max(0,1-distanceToMiddle/(WIDTH/2)))}),this.text.animate({x:textDim.width/2+x+this.PADDING,y:textDim.height/2+y+this.PADDING},300,"<"),this.bringFront()},Keyword.prototype.move=function(x,y){var textDim=this.text.getBBox();this.background.attr({x:x,y:y}),this.handle.attr({x:x,y:y}),this.text.attr({x:textDim.width/2+x+this.PADDING,y:textDim.height/2+y+this.PADDING});var distanceToMiddle=this.distanceTo(WIDTH/2,HEIGHT/2);this.setWeight(Math.max(0,1-distanceToMiddle/(WIDTH/2))),this.bringFront()},Keyword.prototype.dimensions=function(){var dim=this.handle.getBBox();return{x:this.handle.attr("x"),y:this.handle.attr("y"),width:dim.width,height:dim.height}},{scope:{cluster:"=ngModel"},template:'<h2 class="text-center">{[cluster.topic.content]}</h2><div class="cluster-raphael"></div>',link:function(scope,elem){var topic={},keywords=[],raphael=Raphael($(elem).children(".cluster-raphael")[0],WIDTH,HEIGHT);$(elem).addClass("cluster"),initBackground(raphael),topic=new Topic(raphael,{content:"Lorem ipsum dolor sit amet",weight:.9}),topic.render({x:WIDTH/2,y:HEIGHT/2}),topic.handle.dblclick(function(){confirm("Are you sure you want to remove the whole topic?")&&(keywords.forEach(function(keyword){keyword.remove()}),$(elem).addClass("removed"),keywords=[])});for(var i=0;8>i;i++){var keyword=new Keyword(raphael,{content:"Lorem ipsum",weight:Math.random()});keyword.render({x:0,y:0}),keywords.push(keyword)}initKeywords(keywords),raphael.set(_.map(keywords,function(keyword){return keyword.handle})).hover(function(){this.parent.bringFront()}).dblclick(function(){var parent=this.parent;parent.remove(function(){keywords=_.filter(keywords,function(keyword){return keyword!=parent})})}).drag(function(dx,dy){var newX=this.ox+dx,newY=this.oy+dy,dim=this.parent.dimensions(),middle={x:newX+dim.width/2,y:newY+dim.height/2},leftBound=middle.x<0,rightBound=middle.x>WIDTH,topBound=middle.y<0,bottomBound=middle.y>HEIGHT;leftBound&&(newX=-(dim.width/2)),rightBound&&(newX=WIDTH-dim.width/2),topBound&&(newY=-(dim.height/2)),bottomBound&&(newY=HEIGHT-dim.height/2),this.parent.move(newX,newY)},function(){var pos=this.parent.dimensions();this.ox=pos.x,this.oy=pos.y,this.attr({cursor:"move"})},function(){var collision=!1,parent=this.parent;keywords.forEach(function(keyword){parent!=keyword&&parent.collides(keyword)&&(collision=!0)}),collision&&parent.smoothMove(this.ox,this.oy),this.attr({cursor:"pointer"})})}}}),MatchingApp.directive("upload",function(){return{scope:{added:"=",uploaded:"=",files:"="},link:function(scope,elem){$(elem).fileupload().bind("fileuploadadd",function(e,data){scope.added(data)}).bind("fileuploaddone",function(e,data){scope.uploaded(data)})}}}),MatchingApp.controller("IterationController",function($scope){$scope.cluster={topic:{content:"Lorem ipsum dolor sit amet"}}}),MatchingApp.controller("ProfileController",function($scope,$rootScope,Api,Fileupload){$rootScope.activeLink="profile",$scope.bio={editing:!1,content:"**Lorem ipsum**, dolor sit amet",files:[]},Api.getProfile().success(function(profile){console.log(profile)}),Fileupload.init($scope.bio.files),$scope.editBio=function(){$scope.bio.editing=!0},$scope.updateBio=function(){Api.updateBio($scope.bio.content).success(function(){$scope.bio.editing=!1})}});